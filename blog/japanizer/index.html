<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://www.praguevara.dev/ name=base><title>praguevara • I built a ChatGPT wrapper to phonetically transcribe text into Japanese</title><link href="https://www.praguevara.dev/inter_subset_en.css?h=d8cf4ad058d6c3a4015b" rel=stylesheet><link href="https://www.praguevara.dev/main.css?h=2e02623b98889ce02fac" rel=stylesheet><meta content="light dark" name=color-scheme><meta content="praguevara's personal site" name=description><meta content="praguevara's personal site" property=og:description><meta content="index, nofollow" name=robots><meta content="I built a ChatGPT wrapper to phonetically transcribe text into Japanese" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale><meta content=https://www.praguevara.dev/blog/japanizer/ property=og:url><meta content=praguevara property=og:site_name><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self' *.umami.dev analytics.eu.umami.is;script-src 'self' analytics.eu.umami.is 'self'" http-equiv=Content-Security-Policy><noscript><link href=https://www.praguevara.dev/no_js.css rel=stylesheet></noscript><script src=https://www.praguevara.dev/js/initializeTheme.min.js></script><script defer src=https://www.praguevara.dev/js/themeSwitcher.min.js></script><script async data-do-not-track=true data-website-id=0c7e37b7-63ab-4bb1-8569-f3539cca7a85 defer src=https://analytics.eu.umami.is/script.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://www.praguevara.dev>praguevara</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://www.praguevara.dev/blog/> blog </a><li><a class="nav-links no-hover-padding" href=https://www.praguevara.dev/cv> cv </a><li><a class="nav-links no-hover-padding" href=https://www.praguevara.dev/about> about </a><li><a class="nav-links no-hover-padding" href=https://www.praguevara.dev/archive/> archive </a><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>I built a ChatGPT wrapper to phonetically transcribe text into Japanese</h1><ul class=meta><li>17th Oct 2024</li> • <li title="824 words">5 min read</li> • <li>Tags: <li><a href=https://www.praguevara.dev/tags/elixir/>elixir</a>, <li><a href=https://www.praguevara.dev/tags/phoenix/>phoenix</a></ul><section class=body><p><img alt="Japanizer screenshot" src=https://www.praguevara.dev/blog/japanizer/./japanizer_screenshot.png><p>A friend to me told me about their method for learning Japanese. They copied and pasted famous texts (say, the first chapter of <em>El Quijote</em>) and then asked ChatGPT to phonetically transcribe them into Japanese script. Since Spanish is phonetically very similar to Japanese, the output can be quite close, and they used this method to recognize Japanese script.<p>Besides Kanji, which are Chinese characters, Japanese uses another two scripts, <em>Hiragana</em> and <em>Katakana</em>. They represent vowels, syllables and the letter n for some reason.<p>Anyways, I thought that would be a cool side project and a good exercise in Elixir, Phoenix, and LiveView.<p>Check it out at <a href=https://japanizer.praguevara.dev>Japanizer</a>!<h2 id=features><a aria-label="Anchor link for: features" class="header-anchor no-hover-padding" href=#features><span aria-hidden=true class=link-icon></span></a> Features</h2><ul><li>Streaming responses from OpenAI's API with <a href=https://hex.pm/packages/openai>openai</a>.<li>Rate limiting per IP address using <a href=https://github.com/ExHammer/hammer>Hammer</a>.<li>Cool and responsive design using <a href=https://tailwindcss.com/>TailwindCSS</a> (I think).<li>Multi-language support and internationalization with <a href=https://cldr.unicode.org/index>CLDR</a> and <a href=https://hexdocs.pm/gettext/Gettext.html>Gettext</a>. The site changes language based on the browser's locale.<li>Extensive telemetry and logging with <a href=https://hexdocs.pm/prom_ex/readme.html>Prometheus</a>, integrated into Fly.io's Grafana.</ul><h2 id=technology><a aria-label="Anchor link for: technology" class="header-anchor no-hover-padding" href=#technology><span aria-hidden=true class=link-icon></span></a> Technology</h2><p>The first thing I did was to set up a Nix flake. This allowed me to have all dependencies in one place, with no system conflicts or weird bugs. Nix is pretty cool.<p>I then set up a basic Phoenix project, without a DB or authentication, with a LiveView that would handle the transcription. I still used Ecto for validation.<p>Integrating OpenAI was pretty straightforward. Getting streaming to work was a bit tricky, since I had to pass the config explicitly to make it work.<p>I had Claude generate the prompt and a few examples for the API, which worked pretty well, since I can barely read <em>Hiragana</em>.<p>For streaming the results back to the frontend, I used the <code>push_event</code> pattern to send the new deltas as they came in. I then set up a hook at the <code>app.js</code> file, which appended the new text to the existing text. I had to convert the newlines to <code>&LTbr></code> tags to make it work nicely with the HTML. At the start of the project I was sending the whole text each time a new chunk arrived, but this was clearly not a good idea since it's <code>O(n^2)</code>, and it started causing megabytes of data to be sent to the client.<p>I wanted to limit the number of requests per IP address to avoid abuse, so I used <a href=https://github.com/ExHammer/hammer>Hammer</a>. The library is quite simple, and worked out of the box. I had issues trying to get the remote IP address from the LiveView with Fly. I found out about <a href=https://hexdocs.pm/remote_ip/RemoteIp.html>remote_ip</a>, and had to wrestle with it for a bit to get it to work. I had to pass the <code>:x_headers</code> to LiveView like so:<pre class="language-elixir z-code" data-lang=elixir><code class=language-elixir data-lang=elixir><span class="z-source z-elixir">  socket <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>/live<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-entity z-name z-class z-elixir">Phoenix</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">LiveView</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Socket</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">websocket<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">connect_info<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>x_headers</span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">session<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-variable z-other z-module z-elixir"><span class="z-keyword z-operator z-definition z-constant z-elixir">@</span>session_options</span><span class="z-punctuation z-section z-array z-elixir">]</span><span class="z-punctuation z-section z-array z-elixir">]</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">longpoll<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">connect_info<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>x_headers</span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">session<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-variable z-other z-module z-elixir"><span class="z-keyword z-operator z-definition z-constant z-elixir">@</span>session_options</span><span class="z-punctuation z-section z-array z-elixir">]</span><span class="z-punctuation z-section z-array z-elixir">]</span>
</span></code></pre><p>Then, in the <code>mount</code> function, I got the IP address from the socket.<pre class="language-elixir z-code" data-lang=elixir><code class=language-elixir data-lang=elixir><span class="z-source z-elixir">    proxies <span class="z-keyword z-operator z-assignment z-elixir">=</span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-punctuation z-section z-array z-elixir">]</span> <span class="z-comment z-line z-number-sign z-elixir"><span class="z-punctuation z-definition z-comment z-elixir">#</span> A couple of IPs that I got from Fly.io's dashboard
</span></span><span class="z-source z-elixir">    ip <span class="z-keyword z-operator z-assignment z-elixir">=</span>
</span><span class="z-source z-elixir">      get_connect_info<span class="z-punctuation z-section z-function z-elixir">(</span>socket<span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>x_headers</span><span class="z-punctuation z-section z-function z-elixir">)</span>
</span><span class="z-source z-elixir">      <span class="z-keyword z-operator z-pipe z-elixir">|></span> <span class="z-entity z-name z-class z-elixir">RemoteIp</span><span class="z-punctuation z-separator z-method z-elixir">.</span>from<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-constant z-other z-keywords z-elixir">proxies<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> proxies<span class="z-punctuation z-section z-function z-elixir">)</span>
</span><span class="z-source z-elixir">      <span class="z-keyword z-operator z-pipe z-elixir">|></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>inet</span><span class="z-punctuation z-separator z-method z-elixir">.</span>ntoa<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span>
</span><span class="z-source z-elixir">      <span class="z-keyword z-operator z-pipe z-elixir">|></span> to_string<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span>
</span></code></pre><p>This almost worked, but I kept getting an IP that wasn't correct. After some investigation, I found out that the IP was from Cloudflare, and I had forgotten to turn proxy off.<p>For internationalization, I found <a href=https://hexdocs.pm/gettext/Gettext.html>Gettext</a> to be quite easy to use. It has a couple of mix tasks to create the translation files, and then I used Claude to generate the translations for each language. I then used CLDR to find out the appropriate translation according to the browser's locale.<h2 id=hosting><a aria-label="Anchor link for: hosting" class="header-anchor no-hover-padding" href=#hosting><span aria-hidden=true class=link-icon></span></a> Hosting</h2><p>I hosted the app on Fly.io, using a custom DNS set through Cloudflare. I'm really quite liking Fly.io so far. For these kinds of projects, you get a very nice integration with Elixir, managed Postgres, logs, metrics and tons of features.<p>I also experimented with setting up metrics. I added a few:<pre class="language-elixir z-code" data-lang=elixir><code class=language-elixir data-lang=elixir><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir"><span class="z-punctuation z-definition z-comment z-elixir">#</span> Japanizer metrics
</span></span><span class="z-source z-elixir">counter<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>japanizer.japanize.count<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">description<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>The number of times the japanize function is called<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">tags<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>script</span><span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir"><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">counter<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>japanizer.japanize.rate_limit.count<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir"><span class="z-constant z-other z-keywords z-elixir">description<span class="z-punctuation z-definition z-constant z-elixir">:</span></span>
</span><span class="z-source z-elixir">    <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>The number of times the japanize function is called and the rate limit is exceeded<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span>
</span><span class="z-source z-elixir"><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">distribution<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>japanizer.japanize.text_length<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">description<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>The length of the text being japanized<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">unit<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>character</span>
</span><span class="z-source z-elixir"><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">distribution<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>japanizer.japanize.duration<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">description<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>The time it takes to complete a japanization<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">unit<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>native</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>millisecond</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span>
</span><span class="z-source z-elixir"><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">counter<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>japanizer.japanize.error.count<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">description<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>The count of errors during japanization<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">tags<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>error_type</span><span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir"><span class="z-punctuation z-section z-function z-elixir">)</span>
</span></code></pre><p>I could see them in LiveDashboard, but I wanted to be able to access them with Fly.io's Grafana. For this, I found <a href=https://hexdocs.pm/prom_ex/readme.html>prom_ex</a>, which is a Prometheus exporter for Elixir. I had never worked with Prometheus or Grafana before, but it was quite easy to set up and get working.<h2 id=conclusion><a aria-label="Anchor link for: conclusion" class="header-anchor no-hover-padding" href=#conclusion><span aria-hidden=true class=link-icon></span></a> Conclusion</h2><p>I'm quite happy with the result. I think the project is quite minimal and pretty robust, and since the goal was to have fun and learn something new, I consider it a success.</section><nav class="full-width article-navigation"><div></div><div><a aria-describedby=right_title aria-label=Prev href=https://www.praguevara.dev/blog/website-nix/>Prev <span class=arrow>→</span></a><p aria-hidden=true id=right_title>How I build my website</div></nav></article></main><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://www.praguevara.dev/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/praguevara/> <img alt=github loading=lazy src=https://www.praguevara.dev/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://x.com/praguevara> <img alt=x loading=lazy src=https://www.praguevara.dev/social_icons/x.svg title=x> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://www.linkedin.com/in/pablo-ram%C3%B3n-guevara-498283165/> <img alt=linkedin loading=lazy src=https://www.praguevara.dev/social_icons/linkedin.svg title=linkedin> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=/pgp.txt> <img alt=pgp loading=lazy src=https://www.praguevara.dev/social_icons/key.svg title=pgp> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> Powered by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> </small></div></section></footer>